#!/bin/bash

set -euo pipefail

# Determine the correct lib directory based on installation location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if we're running from development directory
if [[ -f "$SCRIPT_DIR/lib/utils.sh" ]]; then
    LIB_DIR="$SCRIPT_DIR/lib"
# Check if we're running from installed location (~/.local/bin)
elif [[ -f "$SCRIPT_DIR/../lib/claude-fork/utils.sh" ]]; then
    LIB_DIR="$SCRIPT_DIR/../lib/claude-fork"
# Check for system-wide installation
elif [[ -f "/usr/local/lib/claude-fork/utils.sh" ]]; then
    LIB_DIR="/usr/local/lib/claude-fork"
else
    echo "Error: Cannot find claude-fork library files" >&2
    echo "Searched in:" >&2
    echo "  $SCRIPT_DIR/lib/utils.sh" >&2
    echo "  $SCRIPT_DIR/../lib/claude-fork/utils.sh" >&2
    echo "  /usr/local/lib/claude-fork/utils.sh" >&2
    exit 1
fi

source "$LIB_DIR/utils.sh"

main() {
    local command="${1:-new}"
    
    case "$command" in
        new)
            shift
            exec "$LIB_DIR/new.sh" "$@"
            ;;
        export)
            shift
            exec "$LIB_DIR/export.sh" "$@"
            ;;
        export-auto)
            shift
            exec "$LIB_DIR/export-auto.sh" "$@"
            ;;
        list)
            shift
            exec "$LIB_DIR/list.sh" "$@"
            ;;
        merge)
            shift
            exec "$LIB_DIR/merge.sh" "$@"
            ;;
        clean)
            shift
            exec "$LIB_DIR/clean.sh" "$@"
            ;;
        clean-forks)
            shift
            exec "$LIB_DIR/clean-forks.sh" "$@"
            ;;
        clean-exports)
            shift
            exec "$LIB_DIR/clean-exports.sh" "$@"
            ;;
        show)
            shift
            exec "$LIB_DIR/show.sh" "$@"
            ;;
        help|-h|--help)
            show_help
            ;;
        version|-v|--version)
            show_version
            ;;
        *)
            log_error "Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

check_dependencies
init_data_dir

main "$@"